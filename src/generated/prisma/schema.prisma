generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

enum PaymentMethod {
  CARD
  ALIPAY
  WECHAT_PAY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentType {
  SUBSCRIPTION
  CREDIT_TOPUP
  ONE_TIME
}

enum CreditTransactionType {
  PURCHASE // User bought credits
  MONTHLY_ALLOCATION // Monthly subscription credits
  DEDUCTION // Used credits for feature
  REFUND // Credits refunded
  BONUS // Bonus credits from promotion
}

model User {
  id                   String                 @id @default(cuid())
  email                String                 @unique
  passwordHash         String?
  displayName          String?
  subscriptionTier     String                 @default("FREE")
  credits              Int                    @default(0)
  customerId           String?                @unique
  subscriptionId       String?
  subscriptionExpiry   DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  lastActivityDate     DateTime?
  learningStreak       Int                    @default(0)
  totalAnalyses        Int                    @default(0)
  wordsLearned         Int                    @default(0)
  AnalyzedVocabulary   AnalyzedVocabulary[]
  PlacementTestAttempt PlacementTestAttempt[]
  UserFlashcard        UserFlashcard[]
  UserLessonProgress   UserLessonProgress[]
  payments             Payment[]
  creditTransactions   CreditTransaction[]
  subscriptions        Subscription[]

  @@index([email])
  @@index([subscriptionTier])
}

model AnalyzedVocabulary {
  id           String   @id @default(cuid())
  userId       String
  word         String
  reading      String?
  romaji       String?
  partOfSpeech String?
  translation  String?
  sentence     String?
  analyzedAt   DateTime @default(now())
  reviewCount  Int      @default(0)
  masteryLevel Int      @default(0)
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([word])
  @@index([userId, word])
}

model Course {
  id                  String   @id @default(cuid())
  level               String
  title               String
  description         String?
  totalLessons        Int
  estimatedHours      Int?
  requiredTier        String   @default("FREE")
  creditCostPerLesson Int      @default(0)
  isPublished         Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lessons             Lesson[]

  @@index([level])
  @@index([isPublished])
}

model Lesson {
  id                 String               @id @default(cuid())
  courseId           String
  lessonNumber       Int
  unitNumber         Int?
  title              String
  description        String?
  vocabularyItems    Json?
  grammarPoints      Json?
  practiceExercises  Json?
  isQuiz             Boolean              @default(false)
  estimatedMinutes   Int                  @default(30)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  course             Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  UserLessonProgress UserLessonProgress[]

  @@unique([courseId, lessonNumber])
  @@index([courseId, lessonNumber])
}

model PlacementQuestion {
  id                  String   @id @default(cuid())
  level               String
  skillType           String
  difficulty          Int
  questionText        String
  questionTextChinese String?
  passageText         String?
  options             Json
  correctAnswerId     String
  explanation         String?
  audioUrl            String?
  timesShown          Int      @default(0)
  timesCorrect        Int      @default(0)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([difficulty])
  @@index([level, skillType, isActive])
}

model LessonNotification {
  id         String    @id
  email      String
  lessonId   String
  notifiedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([email])
  @@index([lessonId])
  @@index([notifiedAt])
}

model PlacementTestAnswer {
  id                   String               @id
  attemptId            String
  questionId           String
  selectedAnswerId     String
  isCorrect            Boolean
  timeSpentSeconds     Int
  answeredAt           DateTime             @default(now())
  PlacementTestAttempt PlacementTestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model PlacementTestAttempt {
  id                    String                @id
  userId                String
  startedAt             DateTime              @default(now())
  completedAt           DateTime?
  initialLevel          String?
  finalRecommendedLevel String?
  skillBreakdown        Json?
  totalQuestions        Int
  totalCorrect          Int
  testDurationSeconds   Int?
  PlacementTestAnswer   PlacementTestAnswer[]
  User                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([completedAt])
  @@index([userId])
}

model UserFlashcard {
  id              String    @id
  userId          String
  word            String
  reading         String?
  translation     String?
  exampleSentence String?
  audioUrl        String?
  sourceLessonId  String?
  timesReviewed   Int       @default(0)
  lastReviewedAt  DateTime?
  nextReviewAt    DateTime?
  easeFactor      Float     @default(2.5)
  interval        Int       @default(0)
  createdAt       DateTime  @default(now())
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, nextReviewAt])
}

model UserLessonProgress {
  id                  String    @id
  userId              String
  lessonId            String
  vocabularyCompleted Boolean   @default(false)
  grammarCompleted    Boolean   @default(false)
  practiceCompleted   Boolean   @default(false)
  practiceScore       Decimal?  @db.Decimal(5, 2)
  isCompleted         Boolean   @default(false)
  completedAt         DateTime?
  lastAccessedAt      DateTime  @default(now())
  currentTab          String?
  scrollPosition      Int?
  Lesson              Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId])
}

// ============================================
// SUBSCRIPTION MANAGEMENT
// ============================================

model Subscription {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Subscription details
  tier   SubscriptionTier
  status SubscriptionStatus @default(ACTIVE)

  // Stripe fields
  stripeSubscriptionId String? @unique
  stripePriceId        String?
  stripeProductId      String?

  // Billing
  billingPeriod      String // 'monthly' or 'yearly'
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Credits
  monthlyCredits Int @default(0) // Credits allocated per month

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

// ============================================
// PAYMENT PROCESSING
// ============================================

model Payment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment details
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("usd")
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  type          PaymentType

  // Stripe fields
  stripePaymentIntentId String? @unique
  stripeInvoiceId       String? @unique

  // Additional payment provider IDs (for Alipay/WeChat)
  externalPaymentId String?

  // Related entities
  subscriptionId String?
  creditAmount   Int? // If payment was for credits

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// CREDIT SYSTEM
// ============================================

model CreditTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transaction details
  amount       Int // Positive for additions, negative for deductions
  balanceAfter Int // Balance after this transaction
  type         CreditTransactionType
  description  String?

  // Related entities
  paymentId       String? // If from purchase
  featureType     String? // e.g., 'premium_pack', 'jlpt_exam'
  relatedEntityId String? // ID of pack or exam

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

// ============================================
// ANALYSIS HISTORY
// ============================================

model Analysis {
  id     String @id @default(cuid())
  userId String

  // Analysis data
  inputText String @db.Text
  result    Json // Store tokenized analysis

  // Metadata
  language  String   @default("ja")
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
